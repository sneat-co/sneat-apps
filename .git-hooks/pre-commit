#!/bin/sh
# To setup git hooks run:
#   > git config core.hooksPath .git-hooks || echo 'Not in a git repo'

echo "Running .git-hooks/pre-commit..."

# Check for circular dependencies
npx madge --circular --extensions ts ./libs
npx madge --circular --extensions ts ./apps

# Get changed TypeScript files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.ts$' || true)

if [ -n "$CHANGED_FILES" ]; then
  echo "TypeScript files changed, running tests for affected projects..."
  # Run tests for affected projects based on staged changes
  # Use HEAD as base (or main if HEAD doesn't exist for initial commit)
  pnpm nx affected --target=test --base=HEAD 2>/dev/null || pnpm nx affected --target=test --base=main
  
  if [ $? -ne 0 ]; then
    echo "âŒ Tests failed. Fix tests before committing."
    echo "ğŸ’¡ Tip: Use 'git commit --no-verify' to skip this check if needed."
    exit 1
  fi
  echo "âœ… All tests passed!"
fi

# Run linters
pnpx lint-staged
