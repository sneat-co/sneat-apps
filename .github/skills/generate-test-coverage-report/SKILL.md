---
name: generate-test-coverage-report
description: "Generate comprehensive test coverage documentation with metrics and visualizations. USE WHEN the user wants to update test coverage documentation, generate coverage reports, or analyze test coverage across the workspace. EXAMPLES: 'update test coverage report', 'regenerate coverage docs', 'show me test coverage', 'analyze coverage metrics'."
---

# Generate Test Coverage Report

This skill generates a comprehensive test coverage report document at `/docs/test-coverage.md` with:
- Overall test coverage metrics (lines, functions, branches, statements)
- Top N projects by uncovered lines (with mermaid visualization)
- Top N projects by uncovered functions (with mermaid visualization)
- Top N projects by uncovered branches (with mermaid visualization)

## When to Use This Skill

Use this skill when:
- The user asks to update or regenerate the test coverage documentation
- The user wants to see current test coverage metrics across all projects
- After significant code changes to track coverage improvements
- When setting up quality gates or CI/CD pipelines
- To identify projects that need more test coverage

## How It Works

The skill uses a Node.js script (`scripts/generate-coverage-report.mjs`) that:

1. **Collects Coverage Data**: Scans the `coverage/` directory for coverage files generated by Vitest
2. **Parses Metrics**: Extracts lines, functions, branches, and statements coverage from:
   - `coverage-final.json` (detailed Istanbul/V8 format)
   - `coverage-summary.json` (summary format)
3. **Calculates Overall Stats**: Aggregates metrics across all projects
4. **Generates Rankings**: Sorts projects by uncovered lines/functions/branches
5. **Creates Visualizations**: Generates mermaid charts for top N projects
6. **Writes Report**: Outputs formatted markdown to `/docs/test-coverage.md`

## Usage

### Basic Usage

To regenerate the coverage report with existing coverage data:

```bash
node scripts/generate-coverage-report.mjs
```

### Generate Fresh Coverage Data

To run all tests with coverage first, then generate the report:

```bash
node scripts/generate-coverage-report.mjs --run-tests
```

**Note:** This will take significant time as it runs tests for all projects.

### Custom Top N

To show more or fewer projects in rankings (default is 10):

```bash
node scripts/generate-coverage-report.mjs --top 15
# or
node scripts/generate-coverage-report.mjs --top=20
```

### Package Script

A convenience script is available in `package.json`:

```bash
pnpm run coverage:report        # Generate report from existing data
pnpm run coverage:report:run    # Run tests + generate report
```

## Prerequisites

Before running the script, ensure:

1. **Coverage data exists**: Run tests with coverage enabled
   ```bash
   pnpm nx run-many --target=test --all --coverage.enabled=true
   ```

2. **Or use specific projects**:
   ```bash
   pnpm nx test <project-name> --coverage.enabled=true
   ```

The script will inform you if no coverage data is found.

## Output Format

The generated `/docs/test-coverage.md` includes:

1. **Overall Metrics Table**: Aggregate coverage across all projects
2. **Pie Chart**: Visual representation of covered vs uncovered lines
3. **Top N by Lines**: Table + bar chart showing projects with most uncovered lines
4. **Top N by Functions**: Table + bar chart for functions
5. **Top N by Branches**: Table + bar chart for branches
6. **Usage Guide**: How to improve coverage
7. **Related Links**: Links to other testing documentation

## Coverage File Formats

The script supports two coverage formats:

### coverage-final.json
Detailed per-file coverage from Istanbul/V8:
- Statement map with execution counts
- Function map with hit counts
- Branch map with taken/not-taken counts
- Line-by-line coverage

### coverage-summary.json
Aggregated summary format:
```json
{
  "total": {
    "lines": { "total": 100, "covered": 80, "pct": 80 },
    "functions": { "total": 20, "covered": 16, "pct": 80 },
    "branches": { "total": 30, "covered": 24, "pct": 80 },
    "statements": { "total": 120, "covered": 96, "pct": 80 }
  }
}
```

## Workflow Example

As an AI agent, here's how to regenerate the report:

1. **Check if coverage data exists:**
   ```bash
   ls -la coverage/
   ```

2. **If coverage is stale or missing, run tests:**
   ```bash
   # Option A: Run for all projects (slow)
   pnpm nx run-many --target=test --all --coverage.enabled=true
   
   # Option B: Run for specific projects only
   pnpm nx test core --coverage.enabled=true
   pnpm nx test auth-core --coverage.enabled=true
   ```

3. **Generate the report:**
   ```bash
   node scripts/generate-coverage-report.mjs
   ```

4. **Verify output:**
   ```bash
   cat docs/test-coverage.md
   ```

5. **Commit changes:**
   ```bash
   git add docs/test-coverage.md
   git commit -m "chore: update test coverage report"
   ```

## Integration with CI/CD

This skill can be integrated into CI/CD pipelines:

```yaml
# Example GitHub Actions workflow
- name: Run tests with coverage
  run: pnpm nx run-many --target=test --all --coverage.enabled=true

- name: Generate coverage report
  run: node scripts/generate-coverage-report.mjs

- name: Commit updated report
  run: |
    git config user.name "github-actions[bot]"
    git config user.email "github-actions[bot]@users.noreply.github.com"
    git add docs/test-coverage.md
    git commit -m "chore: update test coverage report [skip ci]" || true
    git push
```

## Troubleshooting

### No coverage data found

If you see "No coverage data found":
- Ensure tests have been run with `--coverage.enabled=true`
- Check that `coverage/` directory exists and contains project subdirectories
- Verify coverage files are named `coverage-final.json` or `coverage-summary.json`

### Projects missing from report

If some projects are missing:
- Check if they have a `test` target: `nx show projects --withTarget test`
- Verify coverage was generated for those projects
- Look for parsing errors in script output

### Incorrect metrics

If metrics seem wrong:
- Delete the `coverage/` directory and regenerate: `rm -rf coverage/`
- Run tests with `--skip-nx-cache` to bypass cache: 
  ```bash
  pnpm nx run-many --target=test --all --coverage.enabled=true --skip-nx-cache
  ```
- Check Vitest configuration in `vite.config.base.ts`

## Related Files

- `/scripts/generate-coverage-report.mjs` - Main script
- `/scripts/list-uncovered-lines.mjs` - Alternative coverage analysis script
- `/docs/test-coverage.md` - Generated report (output)
- `/docs/COVERAGE-CONFIGURATION.md` - Coverage configuration guide
- `/vite.config.base.ts` - Vitest coverage configuration
- `/TEST_COVERAGE_PLAN.md` - Coverage improvement plan

## Future Enhancements

Possible improvements for this skill:
- Add historical trending (coverage over time)
- Include file-level coverage details
- Generate coverage badges
- Add coverage quality gates
- Compare coverage between branches
- Highlight coverage regressions
