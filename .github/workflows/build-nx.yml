name: Build NX project

on:
  push:
    branches:
      # - renovate/* - do not build renovate branches as they'll be built by PRs
      - main
    paths-ignore:
      - 'docs/**'
  pull_request:
    paths-ignore:
      - 'docs/**'
  merge_group:
    paths-ignore:
      - 'docs/**'

permissions:
  actions: read

jobs:

  build:
    #        needs: pnpm-cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # TODO: document why we need `fetch-depth` and check if it can be 2
          # currently it fails with:
          # pnpm run nx affected --target=build,lint --base=ea7a47aa562a54bea8e4be5237e603f1d5e5e196 --parallel=8
          # NX   Command failed: git diff --name-only --no-renames --relative "ea7a47aa562a54bea8e4be5237e603f1d5e5e196" "84733ee7b6cdce9397f6fc2cb4877184e4ad6432"
          # fatal: bad object ea7a47aa562a54bea8e4be5237e603f1d5e5e196
          # Error: Process completed with exit code 1.
          fetch-depth: 0

      - uses: ./.github/actions/pnpm

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v4

      - name: Check circular dependencies
        run: |
          npx madge --circular --extensions ts ./libs
          npx madge --circular --extensions ts ./apps

      - name: nx lint affected
        run: pnpm run nx affected --target=lint --base=${{ env.NX_BASE }} --parallel=8

      - name: nx build affected
        env:
          # https://stackoverflow.com/a/73429959/1975086
          # https://github.com/angular/angular/issues/38216
          BAZEL_TARGET: '1'
        # https://stackoverflow.com/questions/73876647/using-nx-run-many-shows-another-process-with-id-is-currently-running-ngcc
        # BE AWARE: Adding PARALLEL options may cause build to pass when it should have been failed
        run: pnpm run nx affected --target=build --base=${{ env.NX_BASE }} --parallel=8

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # TODO: document why we need `fetch-depth` and check if it can be 2
          # currently it fails with:
          # pnpm run nx affected --target=build,lint --base=ea7a47aa562a54bea8e4be5237e603f1d5e5e196 --parallel=8
          # NX   Command failed: git diff --name-only --no-renames --relative "ea7a47aa562a54bea8e4be5237e603f1d5e5e196" "84733ee7b6cdce9397f6fc2cb4877184e4ad6432"
          # fatal: bad object ea7a47aa562a54bea8e4be5237e603f1d5e5e196
          # Error: Process completed with exit code 1.
          fetch-depth: 0

      - uses: ./.github/actions/pnpm

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v4

      - name: Cache Vite dependency pre-bundle
        uses: actions/cache@v5
        with:
          path: node_modules/.vite
          key: vite-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            vite-${{ runner.os }}-

      - name: nx test affected (without coverage)
        if: github.ref != 'refs/heads/main'
        run: pnpm run nx affected --target=test --parallel=4 --base=${{ env.NX_BASE }}
      #        timeout-minutes: 5

      - name: Run tests with coverage (only on main branch)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Running affected tests with coverage..."
          pnpm run nx affected --target=test --base=${{ env.NX_BASE }} --coverage --parallel=4 --skip-nx-cache
          echo "Tests completed. Checking for coverage files..."
          find coverage -name "lcov.info" -type f -exec ls -lh {} \; || echo "No coverage files found"
      #        timeout-minutes: 5

      - name: Merge coverage reports
        if: github.ref == 'refs/heads/main' && success()
        run: |
          # Create merged coverage directory
          mkdir -p coverage-merged

          # Find all lcov.info files and check if any exist
          find coverage -name "lcov.info" -type f -size +0 > coverage-files.txt

          if [ -s coverage-files.txt ]; then
            echo "Found $(wc -l < coverage-files.txt) coverage files to merge:"
            cat coverage-files.txt
            
            echo "Sample from first coverage file (before path fix):"
            head -30 $(head -1 coverage-files.txt)
            
            # Fix paths in each lcov file to be relative to workspace root
            echo "Fixing paths in coverage files..."
            while IFS= read -r lcov_file; do
              # Extract the project path from the coverage file path
              # e.g., coverage/libs/components/lcov.info -> libs/components
              project_path=$(dirname "$lcov_file" | sed 's|^coverage/||')
              
              # Validate project_path is not empty and doesn't contain suspicious patterns
              if [ -z "$project_path" ] || [ "$project_path" = "." ]; then
                echo "::warning::Skipping $lcov_file - could not determine project path"
                continue
              fi
              
              echo "Processing $lcov_file with project path: $project_path"
              
              # Create a temp file with fixed paths
              temp_file="${lcov_file}.tmp"
              
              # Process the file: prepend project_path to SF: lines that are relative paths
              awk -v prefix="$project_path/" '
                /^SF:/ {
                  # Extract the path after SF:
                  path = substr($0, 4)
                  # Normalize relative path markers
                  gsub(/^\.\//, "", path)
                  # Skip if path is absolute (starts with /)
                  if (substr(path, 1, 1) == "/") {
                    print $0
                  }
                  # Skip if path already starts with prefix
                  else if (index(path, prefix) == 1) {
                    print $0
                  }
                  # Otherwise prepend prefix
                  else {
                    print "SF:" prefix path
                  }
                  next
                }
                { print }
              ' "$lcov_file" > "$temp_file"
              
              mv "$temp_file" "$lcov_file"
            done < coverage-files.txt
            
            echo "Sample from first coverage file (after path fix):"
            head -30 $(head -1 coverage-files.txt)
            
            # Merge all lcov files into one
            cat $(cat coverage-files.txt) > coverage-merged/lcov.info
            
            # Check if merged file has actual coverage data
            if [ -s coverage-merged/lcov.info ] && grep -q "^SF:" coverage-merged/lcov.info; then
              echo "Successfully merged coverage files"
              echo "Merged coverage file size: $(wc -l < coverage-merged/lcov.info) lines"
              echo "Sample of merged file (first 30 lines):"
              head -30 coverage-merged/lcov.info
              echo "COVERAGE_GENERATED=true" >> $GITHUB_ENV
            else
              echo "::warning::Merged coverage file is empty or invalid"
              echo "COVERAGE_GENERATED=false" >> $GITHUB_ENV
            fi
          else
            echo "::notice::No coverage files found - skipping Coveralls upload"
            echo "COVERAGE_GENERATED=false" >> $GITHUB_ENV
          fi

      - name: Upload coverage to Coveralls
        if: github.ref == 'refs/heads/main' && success() && env.COVERAGE_GENERATED == 'true'
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./coverage-merged/lcov.info
          base-path: .
          debug: true

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - uses: ./.github/actions/pnpm

      - name: Download latest release of `sneat-go-server`
        run: |
          URL=$(curl -s \
            https://api.github.com/repos/sneat-co/sneat-go-server/releases/latest \
            | jq -r '.assets[] | select(.name | test("linux_amd64.tar.gz$")) | .browser_download_url')

          echo "Downloading $URL"
          curl -L -o app.tar.gz "$URL"

          tar -xzf app.tar.gz
          chmod +x sneat-server

      - name: Set up Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache Firebase Emulators
        uses: actions/cache@v5
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pnpm exec playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install chromium --with-deps

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Clone sneat-firebase
        run: git clone --depth 1 https://github.com/sneat-co/sneat-firebase.git ../sneat-firebase

      - name: Run Playwright tests
        run: pnpm exec playwright test
        env:
          NODE_OPTIONS: '--no-deprecation nx'
          GCLOUD_PROJECT: 'demo-sneat-app'
        continue-on-error: true

      - uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
