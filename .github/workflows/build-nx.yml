name: Build NX project

on:
  push:
    branches:
      # - renovate/* - do not build renovate branches as they'll be built by PRs
      - main
    paths-ignore:
      - 'docs/**'
  pull_request:
    paths-ignore:
      - 'docs/**'
  merge_group:
    paths-ignore:
      - 'docs/**'

permissions:
  actions: read

jobs:

  build:
    #        needs: pnpm-cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # TODO: document why we need `fetch-depth` and check if it can be 2
          # currently it fails with:
          # pnpm run nx affected --target=build,lint --base=ea7a47aa562a54bea8e4be5237e603f1d5e5e196 --parallel=8
          # NX   Command failed: git diff --name-only --no-renames --relative "ea7a47aa562a54bea8e4be5237e603f1d5e5e196" "84733ee7b6cdce9397f6fc2cb4877184e4ad6432"
          # fatal: bad object ea7a47aa562a54bea8e4be5237e603f1d5e5e196
          # Error: Process completed with exit code 1.
          fetch-depth: 0

      - uses: ./.github/actions/pnpm

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v4

      - name: Check circular dependencies
        run: |
          npx madge --circular --extensions ts ./libs
          npx madge --circular --extensions ts ./apps

      - name: nx lint affected
        run: pnpm run nx affected --target=lint --base=${{ env.NX_BASE }} --parallel=8

      - name: nx build affected
        env:
          # https://stackoverflow.com/a/73429959/1975086
          # https://github.com/angular/angular/issues/38216
          BAZEL_TARGET: '1'
        # https://stackoverflow.com/questions/73876647/using-nx-run-many-shows-another-process-with-id-is-currently-running-ngcc
        # BE AWARE: Adding PARALLEL options may cause build to pass when it should have been failed
        run: pnpm run nx affected --target=build --base=${{ env.NX_BASE }} --parallel=8

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # TODO: document why we need `fetch-depth` and check if it can be 2
          # currently it fails with:
          # pnpm run nx affected --target=build,lint --base=ea7a47aa562a54bea8e4be5237e603f1d5e5e196 --parallel=8
          # NX   Command failed: git diff --name-only --no-renames --relative "ea7a47aa562a54bea8e4be5237e603f1d5e5e196" "84733ee7b6cdce9397f6fc2cb4877184e4ad6432"
          # fatal: bad object ea7a47aa562a54bea8e4be5237e603f1d5e5e196
          # Error: Process completed with exit code 1.
          fetch-depth: 0

      - uses: ./.github/actions/pnpm

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v4

      - name: nx test affected (without coverage)
        if: github.ref != 'refs/heads/main'
        run: pnpm run nx affected --target=test --base=${{ env.NX_BASE }} --parallel=1
      #        timeout-minutes: 5

      - name: Run tests with coverage (only on main branch)
        if: github.ref == 'refs/heads/main'
        run: pnpm run nx affected --target=test --base=${{ env.NX_BASE }} --coverage --parallel=1 --skip-nx-cache
      #        timeout-minutes: 5

      - name: Merge coverage reports
        if: github.ref == 'refs/heads/main' && success()
        run: |
          # Create merged coverage directory
          mkdir -p coverage-merged

          # Find all lcov.info files and merge them
          find coverage -name "lcov.info" -type f > coverage-files.txt

          if [ -s coverage-files.txt ]; then
            # Merge all lcov files into one
            cat $(cat coverage-files.txt) > coverage-merged/lcov.info
            echo "Merged $(wc -l < coverage-files.txt) coverage files"
            echo "COVERAGE_GENERATED=true" >> $GITHUB_ENV
          else
            echo "::notice::No coverage files found - skipping Coveralls upload"
            echo "COVERAGE_GENERATED=false" >> $GITHUB_ENV
          fi

      - name: Upload coverage to Coveralls
        if: github.ref == 'refs/heads/main' && success() && env.COVERAGE_GENERATED == 'true'
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./coverage-merged/lcov.info

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - uses: ./.github/actions/pnpm

      - name: Download latest release of `sneat-go-server`
        run: |
          URL=$(curl -s \
            https://api.github.com/repos/sneat-co/sneat-go-server/releases/latest \
            | jq -r '.assets[] | select(.name | test("linux_amd64.tar.gz$")) | .browser_download_url')

          echo "Downloading $URL"
          curl -L -o app.tar.gz "$URL"

          tar -xzf app.tar.gz
          chmod +x sneat-server

      - name: Set up Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache Firebase Emulators
        uses: actions/cache@v5
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pnpm exec playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install chromium --with-deps

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Clone sneat-firebase
        run: git clone --depth 1 https://github.com/sneat-co/sneat-firebase.git ../sneat-firebase

      - name: Run Playwright tests
        run: pnpm exec playwright test
        env:
          NODE_OPTIONS: '--no-deprecation nx'
          GCLOUD_PROJECT: 'demo-sneat-app'
        continue-on-error: true

      - uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
