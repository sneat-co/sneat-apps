name: Build NX project

on:
  push:
    branches:
      # - renovate/* - do not build renovate branches as they'll be built by PRs
      - main
    paths-ignore:
      - 'docs/**'
  pull_request:
    paths-ignore:
      - 'docs/**'
  merge_group:
    paths-ignore:
      - 'docs/**'

permissions:
  contents: write  # Required for committing coverage badge
  actions: read

jobs:
  #    pnpm-cache:
  #        runs-on: ubuntu-latest
  #        steps:
  #            -   name: Checkout repository
  #                uses: actions/checkout@v4
  #                with:
  #                    fetch-depth: 0
  #
  #            -   uses: ./.github/actions/pnpm

  build-lint-e2e:
    #        needs: pnpm-cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # TODO: document why we need `fetch-depth` and check if it can be 2
          # currently it fails with:
          # pnpm run nx affected --target=build,lint --base=ea7a47aa562a54bea8e4be5237e603f1d5e5e196 --parallel=8
          # NX   Command failed: git diff --name-only --no-renames --relative "ea7a47aa562a54bea8e4be5237e603f1d5e5e196" "84733ee7b6cdce9397f6fc2cb4877184e4ad6432"
          # fatal: bad object ea7a47aa562a54bea8e4be5237e603f1d5e5e196
          # Error: Process completed with exit code 1.
          fetch-depth: 0

      - uses: ./.github/actions/pnpm

      - name: Check circular dependencies
        run: |
          npx madge --circular --extensions ts ./libs
          npx madge --circular --extensions ts ./apps

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v4

      - name: nx build affected
        env:
          # https://stackoverflow.com/a/73429959/1975086
          # https://github.com/angular/angular/issues/38216
          BAZEL_TARGET: '1'
        # https://stackoverflow.com/questions/73876647/using-nx-run-many-shows-another-process-with-id-is-currently-running-ngcc
        # BE AWARE: Adding PARALLEL options may cause build to pass when it should have been failed
        run: pnpm run nx affected --target=build --base=${{ env.NX_BASE }} --parallel=8

      - name: nx lint affected
        run: pnpm run nx affected --target=lint --base=${{ env.NX_BASE }} --parallel=8

      - name: nx test affected
        run: pnpm run nx affected --target=test --base=${{ env.NX_BASE }} --parallel=4

      - name: Run tests with coverage
        if: github.ref == 'refs/heads/main'
        run: pnpm run nx affected --target=test --base=${{ env.NX_BASE }} --coverage --parallel=4

      - name: Merge coverage reports
        if: github.ref == 'refs/heads/main' && success()
        run: |
          # Create merged coverage directory
          mkdir -p coverage-merged
          
          # Find all coverage-summary.json files and merge them
          find coverage -name "coverage-summary.json" -type f > coverage-files.txt
          
          if [ -s coverage-files.txt ]; then
            # Create a simple merged summary by calculating total coverage
            node -e "
              const fs = require('fs');
              const files = fs.readFileSync('coverage-files.txt', 'utf8').trim().split('\n').filter(Boolean);
              let totalLines = 0, coveredLines = 0;
              let totalStatements = 0, coveredStatements = 0;
              let totalFunctions = 0, coveredFunctions = 0;
              let totalBranches = 0, coveredBranches = 0;
              
              files.forEach(file => {
                try {
                  const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                  const total = data.total;
                  if (total) {
                    totalLines += total.lines.total || 0;
                    coveredLines += total.lines.covered || 0;
                    totalStatements += total.statements.total || 0;
                    coveredStatements += total.statements.covered || 0;
                    totalFunctions += total.functions.total || 0;
                    coveredFunctions += total.functions.covered || 0;
                    totalBranches += total.branches.total || 0;
                    coveredBranches += total.branches.covered || 0;
                  }
                } catch (e) {
                  console.error('Error processing', file, e.message);
                }
              });
              
              const result = {
                total: {
                  lines: { 
                    total: totalLines, 
                    covered: coveredLines, 
                    pct: totalLines > 0 ? Math.round((coveredLines / totalLines) * 10000) / 100 : 0 
                  },
                  statements: { 
                    total: totalStatements, 
                    covered: coveredStatements, 
                    pct: totalStatements > 0 ? Math.round((coveredStatements / totalStatements) * 10000) / 100 : 0 
                  },
                  functions: { 
                    total: totalFunctions, 
                    covered: coveredFunctions, 
                    pct: totalFunctions > 0 ? Math.round((coveredFunctions / totalFunctions) * 10000) / 100 : 0 
                  },
                  branches: { 
                    total: totalBranches, 
                    covered: coveredBranches, 
                    pct: totalBranches > 0 ? Math.round((coveredBranches / totalBranches) * 10000) / 100 : 0 
                  }
                }
              };
              
              fs.writeFileSync('coverage-merged/coverage-summary.json', JSON.stringify(result, null, 2));
              console.log('Merged coverage:', result.total.lines.pct + '% lines');
            "
          else
            echo '{"total":{"lines":{"pct":0},"statements":{"pct":0},"functions":{"pct":0},"branches":{"pct":0}}}' > coverage-merged/coverage-summary.json
          fi

      - name: Generate coverage badge
        if: github.ref == 'refs/heads/main' && success()
        uses: jaywcjlove/coverage-badges-cli@main
        with:
          source: coverage-merged/coverage-summary.json
          output: .github/badges/coverage.svg

      - name: Commit coverage badge
        if: github.ref == 'refs/heads/main' && success()
        # NOTE: This step requires branch protection to allow workflow commits.
        # In repository settings, under Branch protection rules for 'main':
        # - Enable "Allow specified actors to bypass required pull requests"
        # - Add "github-actions" app to the allowed actors
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/badges/coverage.svg
          if git diff --staged --quiet; then
            echo "No changes to coverage badge"
          else
            git commit -m "Update coverage badge [skip ci]"
            git push || {
              echo "Failed to push coverage badge update. This may be due to branch protection rules."
              echo "Please ensure the workflow has write permissions to the repository."
              exit 1
            }
          fi

      # We have firebase-tools in devDependencies
      #            -   uses: sneat-co/sneat-firebase/actions/install-firebase-tools@main

      - name: Download latest release of `sneat-go-server`
        run: |
          URL=$(curl -s \
            https://api.github.com/repos/sneat-co/sneat-go-server/releases/latest \
            | jq -r '.assets[] | select(.name | test("linux_amd64.tar.gz$")) | .browser_download_url')

          echo "Downloading $URL"
          curl -L -o app.tar.gz "$URL"

          tar -xzf app.tar.gz
          chmod +x sneat-server

      - name: Set up Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache Firebase Emulators
        uses: actions/cache@v5
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pnpm exec playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install chromium --with-deps

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Clone sneat-firebase
        run: git clone --depth 1 https://github.com/sneat-co/sneat-firebase.git ../sneat-firebase

      - name: Run Playwright tests
        run: pnpm exec playwright test
        env:
          NODE_OPTIONS: '--no-deprecation nx'
          GCLOUD_PROJECT: 'demo-sneat-app'
        continue-on-error: true

      - uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
