<ion-header>
	<ion-toolbar>
		<ion-title
			>Scrum
			@if (space?.data) {
				&#64; {{ space.data.title }}
			}
		</ion-title>
		<ion-buttons slot="start">
			<ion-back-button [defaultHref]="$defaultBackUrl()" />
		</ion-buttons>
	</ion-toolbar>
</ion-header>

<ion-content>
	<ion-list lines="none">
		<ion-item color="light">
			<ion-buttons slot="start">
				<ion-button
					class="timer"
					size="medium"
					fill="solid"
					color="primary"
					[title]="
						timerState?.status === 'active' ? 'Stop timer' : 'Start time'
					"
					(click)="toggleScrumTimer()"
					[disabled]="!scrum || timerState?.isToggling"
				>
					@if (
						scrum &&
						(!timerState ||
							(timerState &&
								!timerState.isToggling &&
								(!timerState.status || timerState.status === "stopped")))
					) {
						<ion-icon slot="start" name="play-outline" />
					}
					@if (!timerState?.isToggling && timerState?.status === "active") {
						<ion-icon slot="start" name="pause-outline" />
					}
					@if (timerState?.status === "active" || timerState?.elapsedSeconds) {
						<ion-label> Elapsed: {{ totalElapsed }} </ion-label>
					}
					@if (
						scrum &&
						(!timerState ||
							(timerState?.status !== "active" && !timerState?.elapsedSeconds))
					) {
						<ion-label> Start timer </ion-label>
					}
					@if (!scrum || timerState?.isToggling) {
						<ion-spinner slot="start" color="light" name="lines-small" />
					}
					@if (!scrum) {
						<ion-label>Timer</ion-label>
					}
				</ion-button>
				<!--				<ion-button *ngIf="timerState === 'active'" color="primary">-->
				<!--					<ion-icon slot="start" name="stop"></ion-icon>-->
				<!--					<ion-label>Stop</ion-label>-->
				<!--				</ion-button>-->
			</ion-buttons>
			<ion-label />
			<ion-buttons slot="end">
				<ion-button disabled>{{ scrumDate?.toDateString() }}</ion-button>
				<ion-button
					color="primary"
					[title]="prevScrumTitle"
					(click)="changeDate('prev')"
					[disabled]="!prevScrumID"
				>
					<ion-icon name="chevron-back-outline" />
				</ion-button>
				@if (isToday) {
					<ion-button color="primary" (click)="goScrumsList()" title="History">
						<ion-icon name="list-outline" />
					</ion-button>
				}
				@if (!isToday) {
					<ion-button
						color="primary"
						(click)="changeDate('today')"
						title="Go to today's scrum"
						[disabled]="isToday"
					>
						<ion-icon name="today" />
					</ion-button>
				}
				<ion-button
					color="primary"
					[title]="nextScrumTitle"
					(click)="changeDate(nextScrumID ? 'next' : 'today')"
					[disabled]="isToday"
				>
					<ion-icon name="chevron-forward-outline" />
				</ion-button>
			</ion-buttons>
		</ion-item>
	</ion-list>

	<ion-segment [(ngModel)]="tab" (ionChange)="showChanged()">
		<ion-segment-button value="my">
			<ion-label>Me</ion-label>
		</ion-segment-button>
		<ion-segment-button value="team">
			<ion-label>Team</ion-label>
		</ion-segment-button>
		<ion-segment-button value="risks">
			<ion-label color="danger">
				Risks
				@if (scrum?.risksCount) {
					<ion-badge color="danger">{{ scrum?.risksCount }}</ion-badge>
				}
			</ion-label>
		</ion-segment-button>
		<ion-segment-button value="qna">
			<ion-label>
				Q&A
				@if (scrum?.questionsCount) {
					<ion-badge color="primary">{{ scrum?.questionsCount }}</ion-badge>
				}
			</ion-label>
		</ion-segment-button>
	</ion-segment>

	@switch (tab) {
		@case ("my") {
			@for (taskType of taskTypes; track taskType) {
				<sneat-scrum-tasks
					[currentMemberId]="userMemberId"
					[space]="space"
					[scrumId]="scrumID"
					[member]="memberStatus?.member"
					[taskType]="taskType"
					[tasks]="
						(memberStatus?.byType && memberStatus?.byType[taskType]) || []
					"
					[hideTitle]="false"
				/>
			}
			<ion-card>
				<ion-item-divider>
					<ion-label>Personal metrics</ion-label>
				</ion-item-divider>
				<sneat-metrics [metrics]="personalMetrics" />
			</ion-card>
			<sneat-my-retro-items [spaceID]="space?.id" tabAutoSelect="true" />
		}
		@case ("team") {
			@if (!spaceMetrics || spaceMetrics?.length) {
				<ion-card>
					<ion-item-divider>
						@if (spaceMetrics) {
							<ion-icon slot="start" name="thermometer-outline" />
						}
						@if (!spaceMetrics) {
							<ion-spinner slot="start" name="lines-small" color="medium" />
						}
						<ion-label> Shared metrics </ion-label>
					</ion-item-divider>
					@if (spaceMetrics) {
						<sneat-metrics [metrics]="spaceMetrics" />
					}
				</ion-card>
			}
			@if (!displayStatuses) {
				@for (i of [1, 2]; track i) {
					<ion-card>
						<ion-item-divider>
							@if (!spaceMetrics) {
								<ion-spinner slot="start" name="lines-small" color="medium" />
							}
							<ion-label> Team members </ion-label>
						</ion-item-divider>
					</ion-card>
				}
			}
			@if (space?.id && displayStatuses) {
				@for (status of displayStatuses; track trackByMember($index, status)) {
					<ion-card>
						<sneat-scrum-card
							viewMode="team"
							(expandChanged)="onScrumExpandChanged(status.member.id, $event)"
							[isExpanded]="status.member.id === expandedMemberId"
							[space]="space"
							[scrumId]="scrumID"
							[scrum]="scrum"
							[status]="status"
							[currentMemberId]="userMemberId"
							[timer]="timer"
						/>
						@if (status.member.id === expandedMemberId) {
							<ion-item-divider>Personal metrics</ion-item-divider>
							@if (personalMetrics) {
								@for (metric of personalMetrics; track metric) {
									<ion-item>
										@switch (metric.type) {
											@case ("int") {
												@if (
													metric.type === "int" &&
													metric.min !== undefined &&
													metric.max !== undefined
												) {
													<ion-range
														#range
														[(ngModel)]="metric.value"
														[color]="range.value < 80 ? 'danger' : 'primary'"
														pin="true"
														snaps="true"
														ticks="true"
														[min]="metric.min"
														[max]="metric.max"
													>
														<ion-label
															>{{ metric.title }}: {{ range.value }}</ion-label
														>
													</ion-range>
												}
											}
											@case ("bool") {
												<ion-label>
													{{ metric.title }}:
													@if (metric.value) {
														<ion-text [color]="metric.bool.true.color">{{
															metric.bool.true.label
														}}</ion-text>
													}
													@if (!metric.value) {
														<ion-text [color]="metric.bool.false.color">{{
															metric.bool.false.label
														}}</ion-text>
													}
												</ion-label>
												@if (metric.type === "bool") {
													<ion-toggle
														slot="start"
														[color]="
															metric.value
																? metric.bool.true.color
																: metric.bool.false.color
														"
														[(ngModel)]="metric.value"
													/>
												}
											}
										}
									</ion-item>
								}
							}
						}
					</ion-card>
				}
			}
			<ion-card>
				<ion-item-divider>
					<ion-label style="font-weight: bold">Spectators</ion-label>
				</ion-item-divider>
				<ion-item>
					<ion-label color="medium">
						@switch (spectators?.length) {
							@case (undefined) {
								Loading...
							}
							@case (0) {
								There is no followers for your scrums.
							}
							@case (1) {
								There is 1 follower for your scrums.
							}
							@default {
								There is {{ spectators.length }} followers for your scrums.
							}
						}
					</ion-label>
				</ion-item>
			</ion-card>
			<ion-card>
				<ion-card-content>
					<ion-button
						expand="full"
						color="primary"
						fill="solid"
						(click)="navService.navigateToAddMember(navController, space)"
					>
						<ion-icon name="add" slot="start" />
						<ion-label>Add member(s)</ion-label>
					</ion-button>
				</ion-card-content>
			</ion-card>
		}
		@case ("risks") {
			@if (scrum && !scrum.risksCount) {
				<ion-text color="medium" class="ion-padding">
					<p style="text-align: center">
						Sleep tight dear homeland, there is no risks. Yet.
					</p>
				</ion-text>
			}
			@if (space?.id && displayStatuses) {
				@for (status of displayStatuses; track trackByMember($index, status)) {
					@if (status.byType?.risk?.length) {
						<ion-item-divider>
							<ion-label style="font-weight: bold" color="dark">{{
								status.member.title
							}}</ion-label>
						</ion-item-divider>
						<app-scrum-tasks
							[currentMemberId]="userMemberId"
							[team]="space"
							[scrumId]="scrumID"
							[member]="status.member"
							taskType="risk"
							[tasks]="status.byType?.risk"
							[hideTitle]="true"
						/>
					}
				}
			}
		}
		@case ("qna") {
			<div class="ion-padding">
				@if (scrum && !scrum.questionsCount) {
					<ion-text color="medium">
						<p style="text-align: center">There is no questions asked yet.</p>
						<p>
							All question will be send to the whole team 1 hour before
							stand-up.
						</p>
					</ion-text>
				}
				@if (space?.id && displayStatuses) {
					@for (
						status of displayStatuses;
						track trackByMember($index, status)
					) {
						@if (status.byType?.qna?.length) {
							<ion-item-divider>
								<ion-label style="font-weight: bold" color="dark">{{
									status.member.title
								}}</ion-label>
							</ion-item-divider>
							<app-scrum-tasks
								[currentMemberId]="userMemberId"
								[team]="space"
								[scrumId]="scrumID"
								[member]="status.member"
								taskType="qna"
								[tasks]="status.byType?.qna"
								[hideTitle]="true"
							/>
						}
					}
				}
			</div>
		}
	}

	<ion-list style="position: absolute; top: -999px">
		<!-- TODO: How to do preloading right way? -->
		<!-- This is a pre-loaded of components to make sure there is no flickering when we add 1st item -->
		<ion-reorder-group disabled="false">
			<ion-item>
				<ion-reorder slot="start">
					<ion-icon name="swap-vertical-outline" />
				</ion-reorder>
				<ion-label />
			</ion-item>
		</ion-reorder-group>
	</ion-list>
</ion-content>
